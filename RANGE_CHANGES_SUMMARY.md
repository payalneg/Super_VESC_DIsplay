# Сводка изменений: Новый алгоритм расчета Range

## Что изменено

### 1. vesc_battery_calc.h / vesc_battery_calc.cpp
**Добавлено:**
- `float battery_calc_get_remaining_ah(void)` — функция для получения остаточной емкости батареи в Ач

### 2. vesc_rt_data.h / vesc_rt_data.cpp

#### Константы:
```cpp
#define RANGE_UPDATE_DISTANCE_M  100.0f  // Обновление каждые 100 метров
#define RANGE_UPDATE_AH          0.1f    // Обновление каждые 0.1 Ач
```

#### Добавленные переменные состояния:
```cpp
static float last_range_distance_km  // Последняя дистанция при расчете
static float last_range_ah           // Последние Ач при расчете
static float cached_range_km         // Кэшированное значение range
static float cached_ah_per_km        // Кэшированный расход Ah/км
static bool range_initialized        // Флаг инициализации
```

#### Переделанная функция:
```cpp
float vesc_rt_data_get_range_km(void)
```

**Старая логика:**
- Использовала Wh/km для расчета
- Использовала `battery_wh * battery_level` для остатка энергии
- Пересчитывала на каждом вызове

**Новая логика:**
- Использует Ah/km для расчета
- Использует `battery_calc_get_remaining_ah()` для остаточной емкости
- Пересчитывает только при изменении на 100м ИЛИ 0.1Ач
- Кэширует результат между обновлениями

#### Новая функция:
```cpp
float vesc_rt_data_get_efficiency_ahkm(void)
```
Возвращает текущий расход в Ач/км

### 3. Документация
**Создано:**
- `RANGE_CALCULATION_RU.md` — подробное описание алгоритма
- `RANGE_CHANGES_SUMMARY.md` — эта сводка

## Формула расчета

### Было:
```
Range = (battery_wh * battery_level) / (wh_consumed / distance_km)
```

### Стало:
```
Range = remaining_ah / (consumed_ah / distance_km)
```

## Преимущества

✅ **Точность** — использует фактический расход Ah, а не теоретические Wh  
✅ **Реалистичность** — берет остаточную емкость из умного калькулятора батареи  
✅ **Эффективность** — обновление только при значительных изменениях  
✅ **Стабильность** — кэширование устраняет "дрожание" показаний  
✅ **Интеграция** — использует данные из vesc_battery_calc и vesc_trip_persist  

## Условия обновления

Range пересчитывается когда:
1. Пройдено ≥ 100 метров с последнего расчета
2. Потреблено ≥ 0.1 Ач с последнего расчета
3. Первый вызов (инициализация)

## Особые случаи

| Условие | Результат |
|---------|-----------|
| distance < 0.1 км | range = 0.0 км |
| ah_per_km < 0.01 | range = 999.9 км |
| Отрицательные значения | Автоматически обрабатываются |

## Совместимость

✅ Обратная совместимость с существующим кодом  
✅ Не требует изменений в UI  
✅ Автоматически работает с persistent данными  
✅ Интегрируется с battery swap detection  

## Тестирование

Рекомендуется проверить:
1. Корректность отображения range на UI
2. Плавность изменения значения (отсутствие "прыжков")
3. Сохранение состояния после перезагрузки
4. Корректную работу при низком заряде батареи
5. Поведение при рекуперативном торможении

