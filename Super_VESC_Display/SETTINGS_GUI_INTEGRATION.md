# Settings GUI Integration Guide

## Overview
Settings UI is implemented in `custom/custom.c` and automatically initializes when the settings screen is loaded.

## Architecture

### Safe Files (Never Regenerated)
- ✅ `custom/custom.c` - Main settings UI implementation
- ✅ `custom/custom.h` - Settings UI declarations
- ✅ `custom/settings_wrapper.c` - Platform-independent settings wrapper
- ✅ `custom/settings_wrapper.h` - Settings wrapper interface

### Generated Files (May Be Overwritten)
- ⚠️ `generated/setup_scr_settings.c` - Screen setup (generated by GUI Guider)
- ⚠️ `generated/events_init.c` - Event handlers (generated by GUI Guider)

## How It Works

1. **Initialization**: `custom_init()` adds an event handler to the settings screen
2. **Auto-Load**: When settings screen loads, `settings_screen_loaded_event_cb()` fires
3. **UI Creation**: `settings_ui_init()` creates all settings widgets dynamically
4. **Protection**: Double-initialization is prevented by checking if widgets already exist

## If GUI Is Regenerated

If you regenerate GUI in GUI Guider and lose the settings UI, there are two options:

### Option 1: Automatic (Already Implemented) ✅
The event handler in `custom_init()` should automatically recreate the settings UI.
No action needed!

### Option 2: Manual (If Option 1 Doesn't Work)
Add this line to `generated/setup_scr_settings.c` at line 55:

```c
//The custom code of settings.
settings_ui_init(ui);  // ← Add this line
```

## Settings UI Components

All dynamically created in `settings_ui_init()`:

1. **Target VESC ID Slider** (1-254)
   - Blue indicator
   - Real-time label update
   - Auto-save to NVS

2. **CAN Speed Dropdown** (125/250/500/1000 kbps)
   - 4 speed options
   - Warning: Requires restart
   - Auto-save to NVS

3. **Brightness Slider** (0-100%)
   - Orange indicator
   - Immediate visual feedback
   - Auto-save and apply

4. **Controller ID Slider** (1-254)
   - Green indicator
   - Warning: Requires restart
   - Auto-save to NVS

5. **Reset to Defaults Button**
   - Red color
   - Resets all settings
   - Updates UI immediately

6. **Info Label**
   - Shows status messages
   - Green color for success
   - Dynamic updates

## Simulator Compatibility

The settings system works in both simulator and on device:

- **Simulator**: Settings stored in RAM (lost on exit)
- **Device**: Settings stored in ESP32 NVS (persistent)

This is handled automatically by `settings_wrapper.c` which detects the platform.

## Testing

### In Simulator
1. Run GUI simulator
2. Click settings icon on dashboard
3. Adjust sliders/dropdown
4. Verify labels update
5. Click "Reset to Defaults"
6. Return to dashboard and back to verify persistence

### On Device
1. Flash firmware
2. Open settings screen
3. Change settings
4. Reboot device
5. Verify settings are restored from NVS

## Troubleshooting

### Settings UI Not Appearing
1. Check that `custom_init()` is called
2. Verify `ui->settings` object exists
3. Check serial output for initialization logs

### Settings Not Saving
- **Simulator**: Normal behavior (RAM only)
- **Device**: Check NVS space, check debug logs

### After GUI Regeneration
1. Settings UI should auto-initialize via event handler
2. If not working, add manual call (see Option 2 above)
3. Always keep `custom/` folder intact

## File Structure

```
Super_VESC_Display/
├── custom/
│   ├── custom.c              ← Settings UI implementation (SAFE)
│   ├── custom.h              ← Settings UI declarations (SAFE)
│   ├── settings_wrapper.c    ← Platform wrapper (SAFE)
│   └── settings_wrapper.h    ← Wrapper interface (SAFE)
│
├── generated/
│   ├── setup_scr_settings.c  ← Screen setup (GENERATED)
│   ├── events_init.c         ← Events (GENERATED)
│   └── ...
│
└── src/
    ├── dev_settings.cpp          ← Device settings backend
    └── dev_settings.h            ← Settings API
```

## Summary

✅ **Regeneration-safe**: Event handler approach keeps settings UI intact
✅ **Simulator compatible**: Works without ESP32 hardware
✅ **Auto-save**: All changes saved immediately to NVS
✅ **User-friendly**: Sliders, dropdowns, real-time feedback
✅ **Production-ready**: Double-init protection, error handling

---

**Note**: The settings system is designed to survive GUI regeneration. The event-based initialization ensures the UI is always created when needed, without modifying generated files.

