# Функция умного расчета заряда батареи

## Обзор

Super VESC Display теперь включает интеллектуальную систему расчета заряда батареи, которая обеспечивает более точные показания процента заряда, отслеживая фактическое потребление энергии вместо того, чтобы полагаться только на процент, основанный на напряжении от контроллера VESC.

## Как это работает

### Прямой режим (по умолчанию)
- Использует процент заряда батареи напрямую от контроллера VESC
- Основан на сопоставлении напряжения батареи
- Простой и понятный
- Может быть менее точным во время разряда из-за просадки напряжения

### Режим умного расчета
Умный расчет работает с постоянным сохранением состояния и автоматическим определением зарядки:

1. **Постоянное сохранение состояния**
   - Остаточная емкость батареи (Ач) сохраняется во flash-память каждые 30 секунд
   - Последний процент батареи сохраняется для определения зарядки
   - Состояние сохраняется при перезагрузках и продолжается без прерываний

2. **Автоматическое определение зарядки (при запуске)**
   - Загружает сохраненный процент батареи (например, 70%)
   - Считывает текущий процент от контроллера (например, 90%)
   - Если разница > 10% → Батарея заряжена! Сброс к показанию контроллера
   - Если разница < 10% → Продолжение с сохраненного состояния
   - Пример: Сохранено 70%, Текущий 72% → Продолжить отслеживание
   - Пример: Сохранено 70%, Текущий 90% → Батарея заряжена, сброс к 90%

3. **Непрерывное отслеживание**
   - Отслеживает потребленные ампер-часы от контроллера
   - Обновляет остаточную емкость в реальном времени
   - Пример: Если использовано 0.5 Ач за 30 сек → Остаток уменьшается на 0.5 Ач
   - Учитывает рекуперативное торможение (отрицательное потребление добавляет энергию обратно)

4. **Расчет процента**
   - Вычисляет текущий процент: `(Остаток Ач / Емкость Ач) × 100`
   - Более точен во время разряда, чем методы на основе напряжения
   - Сохраняет состояние периодически для сохранения между перезагрузками

5. **Условия автоматического сброса**
   - Изменена емкость батареи в настройках → Немедленный сброс
   - Обнаружена большая зарядка (увеличение >10%) → Сброс к показанию контроллера
   - Ручное переключение режима → Состояние сохраняется для следующего включения умного режима

## Настройка

### Меню настроек

Перейдите на экран настроек для конфигурации:

1. **Емкость батареи (Ah)**
   - Установите фактическую емкость вашей батареи в ампер-часах
   - По умолчанию: `15.0 Ач`
   - Диапазон: от `1.0` до `200.0 Ач` (шаг 0.1 Ач)
   - Используйте кнопки +/- для настройки
   - Примеры емкостей:
     - Малая батарея: 10-15 Ач
     - Средняя батарея: 15-20 Ач
     - Большая батарея: 20-30 Ач
     - Электровелосипед: 10-20 Ач
     - Электросамокат: 7-15 Ач

2. **Режим расчета батареи**
   - **Direct from Controller** (Прямо от контроллера): Традиционный процент на основе напряжения
   - **Smart Calculation** (Умный расчет): Расчет на основе энергии с использованием потребления Ач
   - Настройки сохраняются автоматически

### Когда использовать каждый режим

**Используйте прямой режим когда:**
- Вам нужна простая, традиционная индикация батареи
- Ваша батарея имеет очень стабильную кривую напряжения
- Вы предпочитаете показания на основе напряжения
- Тестирование или устранение неполадок

**Используйте умный расчет когда:**
- Вам нужна более точная оставшаяся емкость
- Ваши поездки различаются по энергопотреблению
- Вам нужна лучшая оценка запаса хода
- У вас есть рекуперативное торможение
- Напряжение батареи проседает под нагрузкой

## Важные примечания

### Калибровка и сохранение состояния
- **Автоматическая калибровка**: Система автоматически определяет зарядку (увеличение >10%)
- **Постоянное состояние**: Состояние батареи сохраняется каждые 30 секунд во flash-память
- **Плавный перезапуск**: Устройство продолжает с сохраненного состояния после перезапуска
- Для принудительной перекалибровки:
  - Зарядите батарею >10% и перезапустите устройство
  - Измените настройку емкости батареи
  - Система автоматически сбросится к показанию контроллера

### Факторы точности
Точность умного расчета зависит от:
- Правильной настройки емкости батареи
- Точности ампер-часов контроллера
- Начального показания уровня батареи от контроллера
- Фактической емкости батареи (может деградировать со временем)

### Рекуперативное торможение
- Умный расчет учитывает рекуперативное торможение
- Если ампер-часы уменьшаются, процент батареи увеличивается
- Более точен, чем методы на основе напряжения во время рекуперации

### Обновление дисплея
- Процент батареи обновляется в реальном времени
- Расчет записывается в лог каждые 5 секунд в режиме отладки
- Показывает: Начальные Ач, Использованные Ач, Оставшиеся Ач, Процент

## Примеры сценариев

### Сценарий 1: Полная батарея (первое использование)
```
Емкость батареи: 15.0 Ач
Сохраненного состояния не найдено
Текущее показание: 100% → 15.0 Ач
После 30 мин езды: -3.5 Ач потреблено
Остаток: 15.0 - 3.5 = 11.5 Ач
Дисплей: 76.7%
Состояние сохранено: 76.7%, 11.5 Ач
```

### Сценарий 2: Перезапуск после поездки (без зарядки)
```
Емкость батареи: 15.0 Ач
Сохраненное состояние: 76.7%, 11.5 Ач
Текущее показание: 78% (напряжение восстановилось в покое)
Разница: 78 - 76.7 = 1.3% (< 10% порог)
Результат: Продолжить с сохраненных 11.5 Ач
После 20 мин езды: -2.0 Ач потреблено
Остаток: 11.5 - 2.0 = 9.5 Ач
Дисплей: 63.3%
```

### Сценарий 3: Перезапуск после зарядки
```
Емкость батареи: 15.0 Ач
Сохраненное состояние: 63.3%, 9.5 Ач
Текущее показание: 95% (батарея заряжена!)
Разница: 95 - 63.3 = 31.7% (> 10% порог)
Результат: ✓ Обнаружена зарядка! Сброс к показанию контроллера
Новый остаток: 95% × 15.0 = 14.25 Ач
Дисплей: 95%
```

### Сценарий 4: С рекуперацией
```
Емкость батареи: 15.0 Ач
Текущий остаток: 7.5 Ач (50%)
Спуск с рекуперацией: -0.8 Ач потреблено (отрицательное = энергия добавлена)
Остаток: 7.5 - (-0.8) = 8.3 Ач
Дисплей: 55.3%
Состояние сохранено автоматически
```

### Сценарий 5: Изменение емкости
```
Емкость батареи: 15.0 Ач → Изменена на 20.0 Ач
Сохраненное состояние: 9.0 Ач остаток
Текущее показание: 60%
Результат: ✓ Обнаружено изменение емкости! Немедленный сброс
Новый остаток: 60% × 20.0 = 12.0 Ач
Дисплей: 60%
Состояние сохранено с новой емкостью
```

## Устранение неполадок

### Процент батареи кажется неправильным
1. Проверьте, что настройка емкости батареи соответствует вашей фактической батарее
2. Попробуйте перекалибровать, перезапустив устройство
3. Проверьте, точно ли показание ампер-часов контроллера
4. Сравните с показанием на основе напряжения (прямой режим)

### Процент увеличивается во время использования
- Это нормально во время рекуперативного торможения
- Проверьте значение ампер-часов контроллера (может быть отрицательным во время рекуперации)

### Процент не обновляется
1. Проверьте, подключен ли ESC (не должно показывать "Not Connected")
2. Убедитесь, что CAN-связь работает
3. Переключитесь в прямой режим, чтобы проверить, получаются ли данные от контроллера

### Сброс не работает
- Кнопка сброса настроек сбрасывает к значениям по умолчанию (15.0 Ач, прямой режим)
- Для повторной калибровки перезапустите устройство или переключите режимы

## Технические детали

### Источники данных
- **Уровень батареи контроллера**: Из RT данных VESC (`battery_level`)
- **Ампер-часы**: Из RT данных VESC (`amp_hours`)
- **Емкость батареи**: Настраивается пользователем в настройках

### Хранение
- Настройки сохраняются в NVS (энергонезависимая память)
- Сохраняются при отключении питания
- Не требуется облако или внешнее хранилище

### Производительность
- Обновление каждые 50мс с обновлением UI
- Минимальная нагрузка на процессор
- Запись расчета в лог каждые 5 секунд для отладки

## Резюме

Умный расчет батареи обеспечивает более точную оценку оставшейся емкости путем:
- ✅ Отслеживания фактического потребления энергии (Ач)
- ✅ Учета рекуперативного торможения
- ✅ Избежания неточностей из-за просадки напряжения
- ✅ Предоставления лучших оценок запаса хода
- ✅ Настройки для батарей любого размера

Настройте емкость вашей батареи и включите умный расчет для лучшего мониторинга батареи!

