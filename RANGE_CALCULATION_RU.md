# Расчет запаса хода (Range Calculation)

## Обзор

Модуль расчета запаса хода использует реалистичный подход на основе фактически потребленных ампер-часов (Ah) и пройденного расстояния для оценки оставшегося запаса хода.

## Принцип работы

### Основная формула

```
Range (km) = Remaining_Ah / Consumption_Ah_per_km
```

Где:
- **Remaining_Ah** — остаточная емкость батареи в Ач (из модуля `vesc_battery_calc`)
- **Consumption_Ah_per_km** — текущий расход в Ач/км, рассчитывается как:
  ```
  Consumption_Ah_per_km = Consumed_Ah / Distance_km
  ```

### Интеллектуальное обновление

Расчет range обновляется не на каждом цикле, а только когда выполняется одно из условий:

1. **Пройдено 100 метров** — значительное изменение дистанции
2. **Потреблено 0.1 Ач** — значительное изменение расхода

Это снижает вычислительную нагрузку и уменьшает «дрожание» значения range на экране.

### Кэширование

Между обновлениями используется кэшированное значение range, что обеспечивает:
- Стабильное отображение на UI
- Минимальную нагрузку на процессор
- Плавное изменение показаний

## Используемые данные

### Источники данных

1. **vesc_trip_persist** — persistent данные поездки:
   - `trip_persist_get_trip_km()` — пройденное расстояние
   - `trip_persist_get_amp_hours()` — потребленные ампер-часы

2. **vesc_battery_calc** — умный калькулятор батареи:
   - `battery_calc_get_remaining_ah()` — остаточная емкость в Ач

### Persistent состояние

Все данные сохраняются в NVS и восстанавливаются после перезагрузки:
- Пройденное расстояние сохраняется между сессиями
- Потребленные Ah сохраняются между сессиями
- Остаточная емкость батареи сохраняется и обновляется

## Преимущества нового алгоритма

### 1. Реалистичность
- Использует **остаточную** емкость, а не полную емкость батареи
- Показывает реальный оставшийся запас хода

### 2. Точность
- Основан на фактическом потреблении Ah, а не теоретических расчетах
- Учитывает стиль вождения и условия эксплуатации

### 3. Эффективность
- Обновление только при значительных изменениях (100м или 0.1Ач)
- Кэширование результатов между обновлениями

### 4. Стабильность
- Минимальное «дрожание» показаний
- Плавное изменение значений на UI

## Особые случаи

### Недостаточно данных
Если пройдено менее 100 метров:
```
range = 0.0 km
```

### Очень низкий расход
Если расход < 0.01 Ач/км (рекуперация или ошибка):
```
range = 999.9 km  // "Бесконечный" запас хода
```

### Отрицательные значения
Все отрицательные значения автоматически обрабатываются модулем `vesc_battery_calc`

## Параметры настройки

### Константы в vesc_rt_data.cpp

```cpp
#define RANGE_UPDATE_DISTANCE_M  100.0f  // Обновление каждые 100 метров
#define RANGE_UPDATE_AH          0.1f    // Обновление каждые 0.1 Ач
```

Эти значения можно изменять для более частых или более редких обновлений.

## API

### Основная функция
```cpp
float vesc_rt_data_get_range_km(void);
```
Возвращает текущий запас хода в километрах.

### Дополнительная функция
```cpp
float vesc_rt_data_get_efficiency_ahkm(void);
```
Возвращает текущий расход в Ач/км.

## Пример расчета

### Исходные данные:
- Пройдено: 10 км
- Потреблено: 2.5 Ач
- Остаточная емкость: 15 Ач

### Расчет:
```
Consumption = 2.5 Ah / 10 km = 0.25 Ah/km
Range = 15 Ah / 0.25 Ah/km = 60 km
```

### Результат:
**Запас хода: 60 км**

## Логирование

При каждом пересчете в лог выводится отладочная информация:
```
Range recalc: Distance=10.00 km, Consumed=2.50 Ah, Remaining=15.00 Ah, 
              Consumption=0.250 Ah/km, Range=60.0 km
```

## Интеграция с UI

Функция `vesc_rt_data_get_range_km()` вызывается из `ui_updater.cpp` для обновления отображения на экране.

Значение обновляется плавно благодаря кэшированию, что обеспечивает хорошую визуализацию без "прыжков".

## Сброс и инициализация

### Автоматический сброс
Range автоматически сбрасывается в следующих случаях:
- При первом запуске
- Когда пройденное расстояние < 100 м

### Ручной сброс
Для сброса trip и Ah используется:
```cpp
battery_calc_reset_trip_and_ah();
```

Это сбросит все persistent данные и начнет расчет заново.

