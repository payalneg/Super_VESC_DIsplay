# VESC Motor Limits Module

## –û–ø–∏—Å–∞–Ω–∏–µ

–ú–æ–¥—É–ª—å –¥–ª—è —á—Ç–µ–Ω–∏—è –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –º–æ—Ç–æ—Ä–∞ VESC:
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ç–æ–∫ –º–æ—Ç–æ—Ä–∞ (Motor Current Max)
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ç–æ–∫ –±–∞—Ç–∞—Ä–µ–∏ (Battery Current Max)  
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –º–æ—â–Ω–æ—Å—Ç—å (Watt Max)
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å (ERPM Max)

## –í–∞–∂–Ω–æ! ‚ö†Ô∏è

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è**:
- ‚úÖ –ö–æ–º–∞–Ω–¥—ã COMM_GET_MCCONF –∏ COMM_SET_MCCONF –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Å—ã–ª–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ BLE bridge
- ‚úÖ VESC Tool –º–æ–∂–µ—Ç —á–∏—Ç–∞—Ç—å –∏ –∏–∑–º–µ–Ω—è—Ç—å –í–°–ï –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –º–æ—Ç–æ—Ä–∞
- ‚ö†Ô∏è –õ–æ–∫–∞–ª—å–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ MCCONF —É–ø—Ä–æ—â–µ–Ω (—Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω—ã–µ –ª–∏–º–∏—Ç—ã)
- üîÑ –î–ª—è –ø–æ–ª–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ –Ω—É–∂–Ω–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ ConfigParams –∏–∑ VESC Tool

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ VESC Tool

### 1. –ß—Ç–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –º–æ—Ç–æ—Ä–∞

```
1. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –¥–∏—Å–ø–ª–µ—é —á–µ—Ä–µ–∑ BLE
2. –í—ã–±–µ—Ä–∏—Ç–µ –≤–∫–ª–∞–¥–∫—É "Motor Configuration"
3. –ù–∞–∂–º–∏—Ç–µ "Read Configuration" 
4. –í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –±—É–¥—É—Ç –ø—Ä–æ—á–∏—Ç–∞–Ω—ã —Å VESC –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
```

### 2. –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤

```
1. –í —Ä–∞–∑–¥–µ–ª–µ "Current Limits":
   - Motor Current Max: –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ç–æ–∫ –º–æ—Ç–æ—Ä–∞ (A)
   - Motor Current Max Brake: –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ç–æ–∫ —Ç–æ—Ä–º–æ–∂–µ–Ω–∏—è (A)
   - Battery Current Max: –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ç–æ–∫ –æ—Ç –±–∞—Ç–∞—Ä–µ–∏ (A)
   - Battery Current Max Regen: –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ç–æ–∫ —Ä–µ–∫—É–ø–µ—Ä–∞—Ü–∏–∏ (A)

2. –í —Ä–∞–∑–¥–µ–ª–µ "ERPM Limits":
   - ERPM Max: –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å
   - ERPM Min: –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å

3. –í —Ä–∞–∑–¥–µ–ª–µ "Wattage Limits":
   - Watt Max: –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –º–æ—â–Ω–æ—Å—Ç—å (W)
   - Watt Min: –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –º–æ—â–Ω–æ—Å—Ç—å —Ç–æ—Ä–º–æ–∂–µ–Ω–∏—è (W)

4. –ù–∞–∂–º–∏—Ç–µ "Write Configuration" –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
```

## –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ (C++ API)

### –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

```cpp
#include "vesc_limits.h"

void setup() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –º–æ–¥—É–ª—å
    vesc_limits_init();
}
```

### –ß—Ç–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤

```cpp
// –ó–∞–ø—Ä–æ—Å–∏—Ç—å –ª–∏–º–∏—Ç—ã —Å VESC (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
uint8_t vesc_id = 0;  // ID —Ü–µ–ª–µ–≤–æ–≥–æ VESC
vesc_limits_request(vesc_id);

// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã (–æ–±—ã—á–Ω–æ –≤ loop)
if (vesc_limits_is_valid()) {
    const vesc_motor_limits_t* limits = vesc_limits_get();
    
    Serial.printf("Motor Current Max: %.2f A\n", limits->l_current_max);
    Serial.printf("Battery Current Max: %.2f A\n", limits->l_in_current_max);
    Serial.printf("ERPM Max: %.0f\n", limits->l_erpm_max);
    Serial.printf("Watt Max: %.0f W\n", limits->l_watt_max);
}
```

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ª–∏–º–∏—Ç–æ–≤ (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–π API)

```cpp
// –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ —Ç–æ–∫–∏
uint8_t vesc_id = 0;
float motor_current_max = 80.0;    // 80A
float battery_current_max = 60.0;  // 60A
vesc_limits_set_current_max(vesc_id, motor_current_max, battery_current_max);

// –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å
float erpm_max = 60000.0;  // 60000 ERPM
vesc_limits_set_speed_max(vesc_id, erpm_max);

// –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –º–æ—â–Ω–æ—Å—Ç—å
float watt_max = 3000.0;  // 3000W
vesc_limits_set_power_max(vesc_id, watt_max);
```

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –ª–∏–º–∏—Ç–æ–≤ —Å—Ä–∞–∑—É

```cpp
vesc_motor_limits_t new_limits;
new_limits.l_current_max = 80.0;       // Motor current
new_limits.l_current_min = -80.0;      // Motor brake current
new_limits.l_in_current_max = 60.0;    // Battery current
new_limits.l_in_current_min = -40.0;   // Battery regen current
new_limits.l_watt_max = 3000.0;        // Power max
new_limits.l_watt_min = -2000.0;       // Power brake max
new_limits.l_erpm_max = 60000.0;       // Speed max
new_limits.l_erpm_min = -60000.0;      // Speed min (reverse)

uint8_t vesc_id = 0;
vesc_limits_set(vesc_id, &new_limits);
```

## BLE Custom Commands

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π

#### –ö–æ–º–∞–Ω–¥–∞ 0xF0: GET_LIMITS
–ó–∞–ø—Ä–æ—Å —Ç–µ–∫—É—â–∏—Ö –ª–∏–º–∏—Ç–æ–≤.

**–§–æ—Ä–º–∞—Ç –∑–∞–ø—Ä–æ—Å–∞:**
```
Byte 0: 0xF0 (GET_LIMITS)
```

**–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:**
```
Byte 0: 0xF0 (GET_LIMITS)
Byte 1: valid_flag (1=valid, 0=invalid)
Byte 2-5: l_current_max (float32)
Byte 6-9: l_current_min (float32)
Byte 10-13: l_in_current_max (float32)
Byte 14-17: l_in_current_min (float32)
Byte 18-21: l_watt_max (float32)
Byte 22-25: l_watt_min (float32)
Byte 26-29: l_erpm_max (float32)
Byte 30-33: l_erpm_min (float32)
```

#### –ö–æ–º–∞–Ω–¥–∞ 0xF1: SET_LIMITS
–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–æ–≤—ã—Ö –ª–∏–º–∏—Ç–æ–≤.

**–§–æ—Ä–º–∞—Ç –∑–∞–ø—Ä–æ—Å–∞:**
```
Byte 0: 0xF1 (SET_LIMITS)
Byte 1-4: l_current_max (float32)
Byte 5-8: l_current_min (float32)
Byte 9-12: l_in_current_max (float32)
Byte 13-16: l_in_current_min (float32)
Byte 17-20: l_watt_max (float32)
Byte 21-24: l_watt_min (float32)
Byte 25-28: l_erpm_max (float32)
Byte 29-32: l_erpm_min (float32)
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

‚ö†Ô∏è **–í–ê–ñ–ù–û**: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ª–∏–º–∏—Ç—ã –º–æ–≥—É—Ç –ø–æ–≤—Ä–µ–¥–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ!

- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ª–∏–º–∏—Ç—ã —Ç–æ–∫–∞ –Ω–µ –ø—Ä–µ–≤—ã—à–∞—é—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ VESC –∏ –º–æ—Ç–æ—Ä–∞
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –¥–æ–ª–∂–Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Ç–∏–ø—É –º–æ—Ç–æ—Ä–∞
- –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ –Ω–∏–∑–∫–∏—Ö –∑–Ω–∞—á–µ–Ω–∏—è—Ö –ø–µ—Ä–µ–¥ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ–º
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ COMM_SET_MCCONF_TEMP –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π (–Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è)
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ COMM_SET_MCCONF –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–æ flash

## –§–æ—Ä–º—É–ª—ã –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏

### ERPM ‚Üí RPM (–º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å)
```cpp
float mechanical_rpm = erpm / motor_pole_pairs;
```

### RPM ‚Üí –°–∫–æ—Ä–æ—Å—Ç—å (–¥–ª—è –∫–æ–ª–µ—Å–∞)
```cpp
float speed_kmh = (rpm * wheel_diameter_m * PI * 60) / 1000;
```

### –¢–æ–∫ ‚Üí –ú–æ—â–Ω–æ—Å—Ç—å
```cpp
float power_watts = voltage_v * current_a;
```

## –ü—Ä–∏–º–µ—Ä—ã —Ç–∏–ø–∏—á–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫

### –≠–ª–µ–∫—Ç—Ä–æ—Å–∞–º–æ–∫–∞—Ç (36V, 500W –º–æ—Ç–æ—Ä)
```cpp
l_current_max = 40.0;       // 40A motor current
l_in_current_max = 30.0;    // 30A battery current
l_watt_max = 1200.0;        // 1200W (—Å –∑–∞–ø–∞—Å–æ–º)
l_erpm_max = 50000.0;       // ~1600 RPM –¥–ª—è 14-–ø–æ–ª—é—Å–Ω–æ–≥–æ –º–æ—Ç–æ—Ä–∞
```

### –≠–ª–µ–∫—Ç—Ä–æ–≤–µ–ª–æ—Å–∏–ø–µ–¥ (48V, 1000W –º–æ—Ç–æ—Ä)
```cpp
l_current_max = 50.0;       // 50A motor current
l_in_current_max = 35.0;    // 35A battery current  
l_watt_max = 1500.0;        // 1500W
l_erpm_max = 60000.0;       // ~2000 RPM
```

### –≠–ª–µ–∫—Ç—Ä–æ—Å–∫–µ–π—Ç–±–æ—Ä–¥ (10S, 2x 1500W –º–æ—Ç–æ—Ä—ã)
```cpp
l_current_max = 80.0;       // 80A per motor
l_in_current_max = 60.0;    // 60A battery per VESC
l_watt_max = 3000.0;        // 3000W per motor
l_erpm_max = 80000.0;       // –≤—ã—Å–æ–∫–∏–µ –æ–±–æ—Ä–æ—Ç—ã
```

## –û—Ç–ª–∞–¥–∫–∞

–í–∫–ª—é—á–∏—Ç–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:
```cpp
#define LOG_LIMITS_ENABLED  1  // –≤ debug_log.h
```

–í Serial Monitor –≤—ã —É–≤–∏–¥–∏—Ç–µ:
```
‚úÖ [LIMITS] Limits module initialized
‚úÖ [LIMITS] Requesting motor limits from VESC ID 0
‚úÖ [LIMITS] Processing MCCONF response (512 bytes)
‚úÖ [LIMITS] Limits updated:
‚úÖ [LIMITS]    Motor Current Max:   60.00 A
‚úÖ [LIMITS]    Battery Current Max: 45.00 A
```

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏

1. **–£–ø—Ä–æ—â–µ–Ω–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ MCCONF**: 
   - –ß–∏—Ç–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ª–µ–π
   - –î–ª—è –ø–æ–ª–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ –Ω—É–∂–Ω–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è ConfigParams –∏–∑ VESC Tool

2. **–í—Ä–µ–º–µ–Ω–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤**:
   - `vesc_limits_set()` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç COMM_SET_MCCONF_TEMP
   - –ò–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ VESC
   - –î–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ VESC Tool

3. **–ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏**:
   - –ú–æ–¥—É–ª—å –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∑–Ω–∞—á–µ–Ω–∏–π
   - –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ª–µ–∂–∏—Ç –Ω–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–µ

## TODO

- [ ] –ü–æ–ª–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ MCCONF —á–µ—Ä–µ–∑ ConfigParams
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è –ª–∏–º–∏—Ç–æ–≤ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
- [ ] UI —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ª–∏–º–∏—Ç–æ–≤ –Ω–∞ –¥–∏—Å–ø–ª–µ–µ
- [ ] –ü—Ä–æ—Ñ–∏–ª–∏ –ª–∏–º–∏—Ç–æ–≤ (—ç–∫–æ–Ω–æ–º/—Å–ø–æ—Ä—Ç/—Ç—É—Ä–±–æ)
- [ ] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ NVS –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞


